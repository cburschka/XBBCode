<?php

/**
 * @file
 * The main module file containing hook implementations.
 */

use Drupal\Core\Form\FormStateInterface;
use Drupal\Core\Render\Element;

/**
 * Regular expression matching any quote delimiter, including escaped quotes.
 */
define('XBBCODE_RE_QUOTE', '"|\'|&(quot|#039);|');

/**
 * Regular expression pattern for parsing a key=value assignment.
 */
define('XBBCODE_RE_ATTR', '(?:\s+(?<key>\w+)=(?<aq>' . XBBCODE_RE_QUOTE . ')(?<value>[^"]*?)\g{aq}(?=\s|\]|$))');

/**
 * Regular expression pattern for parsing a complete tag element.
 */
define('XBBCODE_RE_TAG', '/\[(?<closing>\/)?(?<name>\w+)(?:=(?<bq>' . XBBCODE_RE_QUOTE . ')(?<option>.*?)\g{bq}(?=\s|\])|(?<attrs>' . XBBCODE_RE_ATTR . '+))?\]/i');

/**
 * Implements hook_theme().
 */
function xbbcode_theme() {
  return [
    'xbbcode_plugin_selection' => [
      'render element' => 'fieldset',
      'function' => 'theme_xbbcode_plugin_selection',
    ],
    'xbbcode_tag_list' => [],
  ];
}

/**
 * Renders the plugin selection subform as a table.
 */
function theme_xbbcode_plugin_selection($variables) {
  $fieldset = $variables['fieldset'];
  $table = &$fieldset['tags'];
  $extra = &$fieldset['extra']['tags'];

  $table['#attributes']['id'] = 'xbbcode-plugins';

  foreach (array_keys($table['#options']) as $tag) {
    $table['#options'][$tag]['name']['data'] = drupal_render($extra[$tag]);
  }
  ksort($table['#options']);

  $html = drupal_render($table);
  foreach (Element::children($fieldset) as $element) {
    $html .= drupal_render($fieldset[$element]);
  }
  return $html;
}
